

<div class="row py-2">
    <div class="col-7">
        <h4><%= appLongName %></h4>
    </div>
    <div class="col-5">
        <%= if (current_user_id) { %>
            <%= linkTo(userActivitiesPath({ user_id: current_user_id }), {class: "btn btn-outline-primary float-right", body: "My Activities"}) %>
        <% } %> 
    </div>
</div>

<div class="row py-3">
    <div class="col-sm-12 col-md-4">
        <table class="table table-bordered table-striped">
            <thead class="thead-light text-center">
                <th colspan=4>Total Distance (Km)</th>
            </thead>
            <tbody>
            <%= for (i, row) in totalDistance { %>
                <tr class="<%= convertPodiumClass(i) %>">
                    <td class="align-middle text-center">#<%= i+1 %></td>
                    <td class="align-middle text-center"><%= row.User %></td>
                    <td class="align-middle text-center"><%= row.Distance %></td>
                </tr>
            <% } %>
            </tbody>
        </table>
    </div>

    <div class="col-sm-12 col-md-4">
        <table class="table table-bordered table-striped">
            <thead class="thead-light text-center">
                <th colspan=4>Activity Count</th>
            </thead>
            <tbody>
            <%= for (i, row) in totalCount { %>
                <tr class="<%= convertPodiumClass(i) %>">
                    <td class="align-middle text-center">#<%= i+1 %></td>
                    <td class="align-middle text-center"><%= row.User %></td>
                    <td class="align-middle text-center"><%= row.Count %></td>
                </tr>
            <% } %>
            </tbody>
        </table>
    </div>

    <div class="col-sm-12 col-md-4">
        <table class="table table-bordered table-striped">
            <thead class="thead-light text-center">
                <th colspan=4>Total Time</th>
            </thead>
            <tbody>
            <%= for (i, row) in totalDuration { %>
                <tr class="<%= convertPodiumClass(i) %>">
                    <td class="align-middle text-center">#<%= i+1 %></td>
                    <td class="align-middle text-center"><%= row.User %></td>
                    <td class="align-middle text-center"><%= secondsToHuman(row.Duration) %></td>
                </tr>
            <% } %>
            </tbody>
        </table>
    </div>
</div>


<div class="row p-3">
    <div class="col-12">
        <canvas id="cumulative-distance-chart"></canvas>
    </div>
</div>
<div class="row p-3">
    <div class="col-12">
        <canvas id="distance-chart"></canvas>
    </div>
</div>



<script src="/assets/images/color-hash.js"></script>

<script>
    var colorHash = new ColorHash();
    var xlabel = [];
    for (i=0; i<54; i+=1){ xlabel.push(i); };
 

    async function getDatasets(url){
        const response = await fetch(url, {headers: {'Content-Type': 'application/json'}});
        const userData = await response.json();
        
        var datasets = []

        Object.keys(userData).forEach(function(user, idx) {
            dataset = {
                label: user,
                data: userData[user],
                fill: false,
                backgroundColor: colorHash.hex(user),
                borderColor: colorHash.hex(user),
                borderWidth: 1,
            }
            datasets.push(dataset)
        });
        return datasets
    }

    async function drawChart(elementId, title, xlabel, datasets) {
        var ctx = document.getElementById(elementId).getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [...xlabel],
                datasets: datasets
            },
            options: {
                title: {display: true, text: title, position: "left"},
                hover: {mode: 'nearest', intersect: false},
                tooltips: {mode: 'nearest', intersect: false},
                elements: {point: {radius: 1}},
                aspectRatio: 5,
                scales: {yAxes: [{ticks: {beginAtZero: true}}]}
            }
        }); 
    }


    async function createWeeklyDistancesChart() {
        const datasets = await getDatasets("/dashboard/weekly/distances")
        drawChart('distance-chart', "Weekly Distance (Km)", xlabel, datasets) 
    };


    async function createCumulativeDistancesChart() {
        const datasets = await getDatasets("/dashboard/weekly/cumulative-distances")
        drawChart('cumulative-distance-chart', "Overall Distance (Km)", xlabel, datasets) 
    };

    createWeeklyDistancesChart();
    createCumulativeDistancesChart();
</script>
